<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:jsf="http://xmlns.jcp.org/jsf"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core">
  <f:metadata>
    <f:viewAction action="#{message.showGraphIntro}" />
  </f:metadata>
  <ui:decorate template="./_main.xhtml">
    <ui:define name="content">
      <form class="graph-form" jsf:id="graphForm">
        <div class="clock">Time: </div>

        <section class="graph-form__columns">
          <div class="graph-form__input-column">
            <div class="graph-form__field">
              <label class="graph-form__label">R</label>
              <p:slider for="r" minValue="2.0" maxValue="5.0" step="0.1" onSlideEnd="handleSlideEnd(event, ui)">
                <p:inputText class="graph-form__input" id="r" value="#{graphForm.r}" validator="#{graphForm.validateR}" placeholder="R" type="float" />
              </p:slider>
            </div>
            <div class="graph-form__field">
              <label class="graph-form__label">X</label>
              <h:inputText class="graph-form__input" id="x" name="x" value="#{graphForm.x}" validator="#{graphForm.validateX}" placeholder="X"></h:inputText>
            </div>
            <div class="graph-form__field">
              <label class="graph-form__label">Y</label>
              <h:inputText class="graph-form__input" id="y" name="y" value="#{graphForm.y}" validator="#{graphForm.validateY}" placeholder="Y"></h:inputText>
            </div>
          </div>

          <div class="graph-container graph-form__graph-column">
            <h:outputText value="#{graph.render()}" escape="false" />
          </div>
        </section>

        <div>
          <h:commandButton class="graph-form__button js-submit" value="Решить" action="#{graphForm.compute}" />
          <a class="graph-form__button" jsf:action="#{navigation.history()}" immediate="true">Воспоминания</a>
        </div>
        <h:inputHidden name="shouldCompute" value="#{graphForm.shouldCompute}" id="shouldCompute" />
      </form>
      <script>
        function handleSlideEnd(event, ui) {
          document.querySelector('#graphForm\\:shouldCompute').value = false;
          document.querySelector('.js-submit').click();
        }

        setInterval(function() {
          let cur_date = new Date()
          document.querySelector('.clock').innerHTML = "Time: " + cur_date.getHours() + ":" + cur_date.getMinutes() + 
          ":" + cur_date.getSeconds();
        }, 10000);
        document.addEventListener('DOMContentLoaded', () => {
          document.querySelector('.graph').addEventListener('click', (e) => {
            
            const graph = document.querySelector('.graph');
            const referencePt = graph.createSVGPoint();
            referencePt.x = e.clientX;
            referencePt.y = e.clientY;

            const axisDim = 400;
            const rDim = 160;

            const { x: graphX, y: graphY } = referencePt.matrixTransform(
              graph.getScreenCTM().inverse());

            const x = (graphX - (axisDim / 2)) / rDim;
            const y = -((graphY - (axisDim / 2)) / rDim);
            const r = parseFloat(document.querySelector('#graphForm\\:r').value);
            document.querySelector('#graphForm\\:x').value = (x * r).toFixed(2);
            document.querySelector('#graphForm\\:y').value = (y * r).toFixed(2);

            document.querySelector('.js-submit').click();
          });
        });
      </script>
    </ui:define>
  </ui:decorate>
</html>
